<div id='<%=tabNode%>' style='clear:both; background-color:#aaa; margin-top: 10px;'>
    <div style='float:left;'>
        {{message}}
    </div>
    <div style='float:right;'>
        <button ng-click='unloadModule()'>Close</button>
    </div>
</div>

<script type="text/javascript">
    registerModule('<%=tabModule%>', function (module) {
        module.instanceCount = 0;
        module.ready = function (appId) {
            var appInstance = module.registerApp(appId, { instanceId: ++ module.instanceCount },
                function (app) {
                app.ready = function () {
                    angular.module('tabsApp').controller('<%=tabController%>', function ($scope) {
                        $scope.message = 'Hello there !!';
                        $scope.unloadModule = function() {
                            setTimeout(function(){
                                debugger;
                                module.dispose(appId);
                            },0);
                        };
                    });
                    var element = $('#<%=tabNode%>');
                    var $injector = angular.injector(['ng', 'tabsApp']);
                    element.attr({'ng-controller': '<%=tabController%>'});

                    $injector.invoke(function($rootScope, $compile) {
                        $compile(element[0])($rootScope);
                        $rootScope.$digest();
                        corelib.log('<%=tabModule%>', 'loaded');
                    });
                };
                app.dispose = function () { };
            });
            appInstance.ready();
        };
        module.dispose = function (appId) {
            var element = $('#<%=tabNode%>');
            if (appId && module.apps[appId]) {
                module.apps[appId].dispose();
                delete module.apps[appId];
                if (Object.key(module.apps).length == 0) {
                    module.destruct();
                    element.empty();
                    element.remove();
                }
            } else {
                module.destruct();
                element.empty();
                element.remove();
            }
        };
    }).ready('<%= tabId %>');
</script>